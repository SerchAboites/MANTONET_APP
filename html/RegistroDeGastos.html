<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">


  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- TUS ESTILOS CSS (AHORA ENLAZADOS EXTERNAMENTE) -->
  <link rel="stylesheet" href="/css/RegGastos.css">
  <link rel="stylesheet" href="/css/RegGastos_mobil.css">


  <script>
    // =================================================================
    // --- CONFIGURACIÓN DEL BACKEND ---
    // =================================================================
    // 1. Despliega tu NUEVO archivo Code.gs como una "Aplicación Web".
    // 2. Asegúrate de que "Quién tiene acceso" esté configurado como "Cualquier persona".
    // 3. Copia la URL de esta NUEVA aplicación web y pégala aquí.
    const GAS_FINANZAS_APP_URL = 'https://script.google.com/macros/s/AKfycbx-5a5cJYhxaJpjIFTAjsfmjE5bLGRE_y6P-0sD2s4_h3DMxO1E-rUclSNvGdajNATr/exec'; // <-- ¡Reemplaza esto!
    // =================================================================


    document.addEventListener("DOMContentLoaded", function () {

      // --- Lógica de la cámara (sin cambios) ---
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const cameras = devices.filter(device => device.kind === 'videoinput');
          console.log(`Cámaras disponibles: ${cameras.length}`);
          cameras.forEach((camera, index) => {
            console.log(`Cámara ${index + 1}:`, camera.label || 'Sin etiqueta (requiere permiso)');
          });
        })
        .catch(error => {
          console.error('Error al enumerar dispositivos:', error);
        });

      const video = document.getElementById('video');
      const captureButton = document.getElementById('captureButton');
      const canvas = document.getElementById('canvas');
      const context = canvas.getContext('2d');
      const cameraSelect = document.getElementById('cameraSelect');

      let currentStream = null;
      let videoAspectRatio = 1; // Relación de aspecto de la cámara

      function getCameras() {
        navigator.mediaDevices.enumerateDevices()
          .then(devices => {
            const cameras = devices.filter(device => device.kind === 'videoinput');
            cameraSelect.innerHTML = ''; // Limpiar las opciones anteriores
            cameras.forEach((camera, index) => {
              let option = document.createElement('option');
              option.value = camera.deviceId;
              option.textContent = camera.label || `Cámara ${index + 1}`;
              cameraSelect.appendChild(option);
            });

            const storedCamera = localStorage.getItem('preferredCamera');
            if (storedCamera) {
              cameraSelect.value = storedCamera;
              switchCamera(storedCamera);
            } else if (cameras.length > 0) {
              switchCamera(cameras[0].deviceId);
            }
          })
          .catch(error => {
            console.error('Error al obtener las cámaras:', error);
          });
      }

      function switchCamera(deviceId) {
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        const constraints = {
          video: {
            deviceId: { exact: deviceId },
            width: { ideal: 3840 },
            height: { ideal: 2160 },
            facingMode: 'user',
            focusMode: 'continuous'
          }
        };

        navigator.mediaDevices.getUserMedia(constraints)
          .then(stream => {
            video.srcObject = stream;
            video.play();
            video.onloadedmetadata = () => {
              const videoWidth = video.videoWidth;
              const videoHeight = video.videoHeight;
              videoAspectRatio = videoWidth / videoHeight;
              const canvasWidth = window.innerWidth * 0.6;
              const canvasHeight = canvasWidth / videoAspectRatio;
              canvas.width = videoWidth;
              canvas.height = videoHeight;
              video.width = canvasWidth;
              video.height = canvasHeight;
            };
            currentStream = stream;
          })
          .catch(error => {
            console.error('Error al acceder a la cámara en 4K:', error);
            switchToBestAvailableResolution(deviceId);
          });
      }

      function switchToBestAvailableResolution(deviceId) {
        const fallbackConstraints = {
          video: {
            deviceId: { exact: deviceId },
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            facingMode: 'user',
            focusMode: 'continuous'
          }
        };
        navigator.mediaDevices.getUserMedia(fallbackConstraints)
          .then(stream => {
            video.srcObject = stream;
            video.play();
            video.onloadedmetadata = () => {
              const videoWidth = video.videoWidth;
              const videoHeight = video.videoHeight;
              videoAspectRatio = videoWidth / videoHeight;
              const canvasWidth = window.innerWidth * 0.6;
              const canvasHeight = canvasWidth / videoAspectRatio;
              canvas.width = videoWidth;
              canvas.height = videoHeight;
              video.width = canvasWidth;
              video.height = canvasHeight;
            };
            currentStream = stream;
          })
          .catch(error => {
            console.error('Error al acceder a la cámara en resolución de respaldo:', error);
          });
      }

      cameraSelect.addEventListener('change', function () {
        const deviceId = cameraSelect.value;
        if (deviceId) {
          localStorage.setItem('preferredCamera', deviceId);
          switchCamera(deviceId);
        }
      });

      getCameras();

      let previousCanvas = null;

      captureButton.addEventListener('click', (event) => {
        event.preventDefault();
        if (currentStream) {
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          const base64Image = canvas.toDataURL('image/png');
          console.log("La información de la Imagen es: " + base64Image);

          if (previousCanvas) {
            previousCanvas.remove();
          }

          const newCanvas = document.createElement('canvas');
          const imagenPrototipoDiv = document.getElementById('imagenPrototipo');
          imagenPrototipoDiv.appendChild(newCanvas);
          const newContext = newCanvas.getContext('2d');
          const contenedorWidth = imagenPrototipoDiv.offsetWidth;
          const img = new Image();
          img.onload = () => {
            const aspectRatio = img.width / img.height;
            const newWidth = contenedorWidth;
            const newHeight = newWidth / aspectRatio;
            newCanvas.width = newWidth;
            newCanvas.height = newHeight;
            newContext.drawImage(img, 0, 0, newCanvas.width, newCanvas.height);
          };
          img.src = base64Image;
          previousCanvas = newCanvas;
        }
      });

      // --- Lógica de botones y listeners (sin cambios) ---
      const uploadBtn = document.getElementById('uploadBtn');
      const fileInput = document.getElementById('ticketImage');

      uploadBtn.addEventListener('click', function () {
        fileInput.click();
      });

      fileInput.addEventListener('change', function () {
        const fileName = fileInput.files[0]?.name;
        if (fileName) {
          console.log(`Archivo seleccionado: ${fileName}`);
        }
      });

      const selectTicket = document.getElementById('ticket');
      selectTicket.addEventListener('change', actualizarVisibilidadFieldset);

    });
    // --- FIN DEL DOMCONTENTLOADED ---


    async function activarCamara() {
      // Esta función parece estar incompleta en tu original, 
      // la lógica principal ya está en getCameras() y switchCamera()
      console.log("Se activó la función de la cámara (placeholder)");
    }

    function setFechaOperacion() {
      let today = new Date();
      today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
      let date = today.toISOString().split('T')[0];
      document.getElementsByName('fechaOperacion')[0].value = date;
      document.getElementsByName('fechaOperacion')[0].style.textAlign = 'center';
    }

    function estimarTamanoEnvio(datos, base64Image) {
      const json = JSON.stringify(datos);
      const datosBytes = new TextEncoder().encode(json).length;
      const base64Bytes = base64Image ? (base64Image.length * 3) / 4 : 0;
      return datosBytes + base64Bytes;
    }


    function actualizarVisibilidadFieldset() {
      const select = document.getElementById('ticket');
      const fieldset = document.getElementById('ticketFieldset');
      const subirTicketDiv = document.getElementById('subirTicket');
      console.log("El Formulario se actualizo SI NO");
      if (select.value === 'SI') {
        fieldset.style.display = 'flex';
        subirTicketDiv.style.display = 'flex';
        // activarCamara(); // Esta función no parece hacer nada, la lógica ya se carga.
      } else {
        fieldset.style.display = 'none';
        subirTicketDiv.style.display = 'none';
      }
    }


    function simularCarga(tamanoEstimado) {
      const duracionTotal = Math.min(4000 + tamanoEstimado / 2, 25000);
      const barra = document.getElementById('barraCarga');
      let progreso = 0;
      let inicio = Date.now();
      const intervalo = setInterval(() => {
        const tiempoTranscurrido = Date.now() - inicio;
        progreso = Math.min((tiempoTranscurrido / duracionTotal) * 100, 100);
        barra.style.width = progreso + '%';
        if (progreso >= 100) {
          clearInterval(intervalo);
        }
      }, 100);
    }


    function enviarDatos(event) {
      event.preventDefault();
      let formData = new FormData(document.getElementById('registroForm'));
      let datos = {};
      formData.forEach((value, key) => {
        datos[key] = value;
      });

      let ticketFileInput = document.getElementById('ticketImage');
      let ticketFile = ticketFileInput ? ticketFileInput.files[0] : null;
      let base64Image = null;

      if (ticketFile) {
        let reader = new FileReader();
        reader.onloadend = function () {
          base64Image = reader.result.split(',')[1];
          enviarDatosServidor(datos, base64Image);
        };
        reader.readAsDataURL(ticketFile);
      } else {
        // Si no hay archivo, usamos la imagen capturada en el canvas
        let canvas = document.getElementById('canvas');
        // Validar si el canvas está vacío (no se ha tomado foto)
        if (canvas.toDataURL() === document.createElement('canvas').toDataURL()) {
          // Si el ticket es "SI" pero no se ha tomado foto NI subido archivo
          if(document.getElementById('ticket').value === 'SI') {
             console.log("Ticket 'SI' pero no se capturó ni subió imagen. Usando base64 nulo.");
             base64Image = null; // Enviar nulo si es 'SI' pero no hay imagen
          } else {
             base64Image = "NO"; // Es 'NO'
          }
        } else {
          // Se tomó foto con la cámara
          base64Image = canvas.toDataURL('image/png').split(',')[1];
        }
        enviarDatosServidor(datos, base64Image);
      }
    }

    // =================================================================
    // --- FUNCIÓN 'enviarDatosServidor' MODIFICADA PARA USAR FETCH ---
    // =================================================================
    async function enviarDatosServidor(datos, base64Image) {
      var seleccion = document.getElementById('opcionSelect').value;
      var ids = {
        'ALSE': '15zTEe8GMA4Ji2b8GWEP94DHvfdcCqlYOSFdQG8honk4',
        'MANTONET': '1r4Xl5yXN8SaSNnIJyDTjK0JmjVTnE394jxLjhiHf5YM'
      };
      var selectedId = ids[seleccion];

      if (!selectedId) {
        alert('Seleccione una opción válida.');
        return;
      }
      datos.opcionSelect = seleccion;
      console.log("Valor de opcionSelect enviado:", seleccion);

      // Validar URL
      if (GAS_FINANZAS_APP_URL === 'URL_DE_TU_NUEVA_WEB_APP_AQUI') {
        alert('Error de configuración: Debes editar el archivo index.html y añadir la URL de tu Google Apps Script en la variable "GAS_FINANZAS_APP_URL".');
        return;
      }

      document.getElementById('registroForm').style.display = 'none';
      document.getElementById('loadingMessage').style.display = 'flex';

      const tamanoEstimado = estimarTamanoEnvio(datos, base64Image);
      simularCarga(tamanoEstimado);

      var ticketSiNo = document.getElementById('ticket').value;
      if (ticketSiNo == "NO") {
        base64Image = "NO";
      }

      // --- INICIO DE LA NUEVA LÓGICA FETCH (POST) ---
      try {
        // Preparamos el payload para enviar
        const payload = {
          sheetId: selectedId,
          sheetName: 'BD', // Este valor estaba 'hardcodeado' en tu google.script.run
          datos: datos,
          base64Image: base64Image
        };

        const response = await fetch(GAS_FINANZAS_APP_URL, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8',
          },
          body: JSON.stringify(payload) // Enviamos el payload completo
        });

        const responseText = await response.text();
        console.log('Respuesta recibida (texto):', responseText);

        if (!response.ok) {
           let errorMsg = `Error de red: ${response.status}`;
           try { errorMsg = JSON.parse(responseText).message || errorMsg; } catch (e) {}
           throw new Error(errorMsg);
        }

        const result = JSON.parse(responseText);

        if (result.status === 'success') {
          // ¡Éxito! Llamar a la función original
          mostrarPanelExito(result.message); // result.message contendrá "Registro exitoso."
        } else {
          // El backend reportó un error
          throw new Error(result.message || 'Error desconocido del servidor.');
        }

      } catch (error) {
        // --- Lógica de Falla (tu .withFailureHandler) ---
        alert('Error al enviar el registro: ' + error.message);
        document.getElementById('registroForm').style.display = 'flex';
        document.getElementById('loadingMessage').style.display = 'none';
      }
      // --- FIN DE LA NUEVA LÓGICA FETCH (POST) ---
    }
    
    // =================================================================
    // --- NUEVA FUNCIÓN PARA CARGAR PROYECTOS ---
    // =================================================================
    async function cargarProyectos() {
      console.log("Cargando lista de proyectos...");
      if (GAS_FINANZAS_APP_URL === 'URL_DE_TU_NUEVA_WEB_APP_AQUI') {
        console.error("La URL de GAS no está configurada. No se pueden cargar proyectos.");
        // Opcionalmente, deshabilita el dropdown
        document.getElementById('proyecto').disabled = true;
        return;
      }
      
      try {
        // Usamos GET para obtener datos
        const response = await fetch(GAS_FINANZAS_APP_URL, {
          method: 'GET',
          mode: 'cors'
        });
        
        const responseText = await response.text();
        if (!response.ok) {
           throw new Error(`Error de red al cargar proyectos: ${response.status}`);
        }

        const result = JSON.parse(responseText);

        if (result.status === 'success' && result.proyectos) {
          const selectProyecto = document.getElementById('proyecto');
          // Limpiar opciones existentes (excepto la primera "disabled")
          while (selectProyecto.options.length > 1) {
             selectProyecto.remove(1);
          }
          
          // Llenar el dropdown
          result.proyectos.forEach(proyecto => {
            let option = document.createElement('option');
            option.value = proyecto;
            option.textContent = proyecto;
            selectProyecto.appendChild(option);
          });
          console.log("Proyectos cargados exitosamente.");
        } else {
           throw new Error(result.message || "No se recibieron datos de proyectos.");
        }

      } catch (error) {
        console.error('Error al cargar la lista de proyectos:', error);
        alert('No se pudo cargar la lista de proyectos. ' + error.message);
      }
    }


    // --- Ejecutar al cargar la página ---
    window.onload = () => {
      setFechaOperacion();
      cargarProyectos(); // <-- ¡NUEVA LLAMADA!
      actualizarVisibilidadFieldset(); // <-- Ejecutar para estado inicial
    };


    function formatearMonto(input) {
      let valor = input.value.replace(/[^0-9.]/g, '');
      let cursorPos = input.selectionStart;
      let puntoIndex = valor.indexOf('.');

      if (puntoIndex !== -1) {
        let partes = valor.split('.');
        partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        valor = partes.join('.');
      } else {
        valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
      input.value = `$ ${valor}`;
      let nuevoCursorPos = Math.min(valor.length + 2, input.value.length);
      input.setSelectionRange(nuevoCursorPos, nuevoCursorPos);
    }

    function mostrarPanelExito() {
      const successPanel = document.getElementById('successPanel');
      successPanel.style.display = 'flex';
      const successSound = document.getElementById('successSound');
      successSound.play().catch(e => console.error("Error al reproducir sonido:", e));

      setTimeout(() => {
        successPanel.style.display = 'none';
        document.getElementById('registroForm').reset();
        document.getElementById('registroForm').style.display = 'flex';
        document.getElementById('loadingMessage').style.display = 'none';
        actualizarVisibilidadFieldset();
        setFechaOperacion();
        
        let base64Image = null;
        console.log("La información de la imagen es: " + base64Image);
        
        document.getElementById('imagenPrototipo').innerHTML = '';
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        const isEmpty = imageData.every(value => value === 0);
        if (isEmpty) {
          console.log("✅ El contenido del canvas se ha borrado correctamente.");
        } else {
          console.log("❌ El canvas todavía tiene contenido.");
        }
      }, 2500);
    }
  </script>

</head>

<body>

  <audio id="successSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"
    preload="auto"></audio>

  <div id="successPanel"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; flex-direction: column;">
    <div
      style="background-color: white; padding: 40px; border-radius: 10px; text-align: center; font-family: 'Josefin Sans', sans-serif; color: #333; max-width: 90%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">

      <svg width="80px" height="80px" viewBox="0 0 133 133" version="1.1" xmlns="http://www.w3.org/2000/svg">
        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
          <circle fill="#4CAF50" cx="66.5" cy="66.5" r="54.5" />
          <polyline stroke="#FFFFFF" stroke-width="10" points="41.5 67 58.5 84 91.5 51" />
        </g>
      </svg>

      <h2 style="font-weight: 600; margin-top: 20px; color: #4CAF50;">¡Éxito!</h2>
      <p style="font-size: 1.2em;">Registro realizado correctamente.</p>
    </div>
  </div>

  <div class="main-content">
    
    <!-- Letrero de carga (sin cambios) -->
    <div id="loadingMessage" style="display: none;">
      <svg id="Capa_2" data-name="Capa 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 604.9 649.25">
        <defs>
          <style>
            @keyframes fadeIn {
              0% {
                opacity: 0;
                transform: scale(0.9);
              }
              100% {
                opacity: 1;
                transform: scale(1);
              }
            }
            .parte {
              opacity: 0;
              animation: aparecer 1s ease-in-out infinite;
            }
            .parte1 {
              animation-delay: 0s;
              fill: white;
            }
            .parte2 {
              animation-delay: 0.7s;
              fill: white;
            }
            .parte3 {
              animation-delay: .3s;
              fill: white;
            }
            @keyframes aparecer {
              0% { opacity: 0; }
              50% { opacity: 1; }
              100% { opacity: 0; }
            }
          </style>
        </defs>
        <g id="Capa_4" data-name="Capa 4">
          <path class="parte parte1" d="m58.79,202.41c-2.09-12.2,10.5-24.41,42.12-40.83,24.81-12.89,60.57-27.74,103.55-43.01,15.59-19.9,32.71-39.45,51.1-58.37-67.16,11.45-122.02,27.34-163.35,47.35-27.06,13.1-48.45,28.08-63.58,44.53C12.51,169.6,3.11,189.28.69,210.57c-2.15,18.89.69,32.43,8.69,41.39,9.02,10.11,25.2,15.02,49.47,15.02,16.45,0,36.73-2.31,61.88-7.07,5.79-13.8,12.21-27.54,19.16-41.05-11.98.86-22.65,1.29-31.78,1.29-22.88,0-46.63-2.11-49.31-17.74Z" />
          <path class="parte parte3" d="m246.13,641.18c-118.35-350.81,10.2-241.58,32.17-202.21,23.89,42.82,90.77,59.8,128.36,47.15.72-13.45.75-26.48.07-38.93-29.62,17.06-77.24,1.36-93.19-31.19-57.98-118.34-272.68-91.64-67.4,225.19Z" />
          <path class="parte parte2" d="m487.43,39.95c-28.21.62-61.48,1.93-97.08,4.49,3.65,5.01,7.2,10.19,10.61,15.51,29.18-7.32,58.06-13.99,86.47-20Z" />
          <path class="parte parte2" d="m446.93,207.15c-2-.11-4.03-.18-6.06-.24-.46-.01-.92-.03-1.38-.04-2-.05-4.02-.07-6.06-.08-.83,0-1.66,0-2.49.01-.6,0-1.19,0-1.79.01-.89.01-1.79.03-2.69.05-.58.01-1.15.02-1.74.04-1.04.03-2.09.07-3.13.11-.95.04-1.89.08-2.85.12-.97.04-1.93.09-2.91.14-.76.04-1.53.09-2.29.14-.75.05-1.49.09-2.25.14-.81.05-1.62.12-2.43.17-.71.05-1.43.1-2.14.16-.84.07-1.69.14-2.54.21-.69.06-1.38.11-2.07.18-.87.08-1.74.16-2.62.25-.68.06-1.35.13-2.03.2-.88.09-1.77.18-2.66.28-.67.07-1.35.14-2.02.22-.9.1-1.81.2-2.72.31-.67.08-1.33.15-2,.23-.92.11-1.84.23-2.77.34-.66.08-1.32.16-1.97.25-.94.12-1.89.25-2.83.37-.64.09-1.29.17-1.94.26-.96.13-1.93.27-2.9.41-.63.09-1.26.18-1.89.27-.99.14-1.98.29-2.97.44-.61.09-1.23.19-1.85.28-1.01.16-2.03.31-3.04.48-.59.09-1.18.19-1.77.29-1.05.17-2.1.34-3.15.52-.56.09-1.11.19-1.67.28-1.09.18-2.18.37-3.27.56-.52.09-1.04.18-1.56.27-1.13.2-2.27.4-3.41.6-.46.08-.92.17-1.39.25-1.2.22-2.4.44-3.61.66-.36.07-.72.14-1.08.2-1.31.25-2.61.49-3.92.75-.21.04-.41.08-.62.12-12.79,2.48-25.77,5.28-38.84,8.28-.12.03-.24.06-.36.08-1.5.35-3.01.69-4.51,1.04-.19.04-.38.09-.57.13-1.49.35-2.97.7-4.46,1.05-.19.05-.39.09-.58.14-1.48.35-2.95.7-4.43,1.05-.21.05-.43.1-.64.15-1.48.35-2.96.71-4.43,1.07-.2.05-.4.1-.6.15-1.51.37-3.02.73-4.52,1.1-.16.04-.32.08-.47.12-1.54.38-3.08.76-4.62,1.14-.12.03-.25.06-.37.09-1.6.39-3.2.79-4.79,1.19-.02,0-.05.01-.07.02-12.64,3.15-25.25,6.37-37.75,9.57-9.34,2.39-18.63,4.77-27.79,7.09-.14.03-.27.07-.41.1-1.51.38-3.01.76-4.51,1.14-.34.09-.68.17-1.03.26-1.28.32-2.57.64-3.84.96-.5.12-1,.25-1.49.37-1.13.28-2.26.56-3.39.84-.59.15-1.17.29-1.76.43-1.05.26-2.09.52-3.13.77-.62.15-1.24.3-1.86.45-1.01.25-2.01.49-3.01.73-.66.16-1.31.32-1.97.48-.95.23-1.9.46-2.85.69-.69.16-1.37.33-2.05.49-.92.22-1.84.44-2.76.66-.7.17-1.4.33-2.1.5-.9.21-1.81.42-2.71.63-.7.16-1.4.33-2.09.49-.89.21-1.78.41-2.67.62-.7.16-1.4.32-2.1.48-.88.2-1.76.4-2.64.6-.69.16-1.38.31-2.07.47-.89.2-1.78.4-2.67.59-.67.15-1.35.3-2.02.45-.89.19-1.77.38-2.65.57-.67.14-1.33.29-2,.43-.92.2-1.84.39-2.75.58-.61.13-1.23.26-1.84.39-1.04.22-2.07.43-3.1.64-.48.1-.97.2-1.45.3-1.51.31-3.02.61-4.52.9-42.57,103.9-44.85,198.26-37.86,263.27.51,4.75,1.07,9.34,1.67,13.77,6.43,47.64,17.17,76.27,17.17,76.27-4.05-26.04-5.14-51.97-4.07-77.24.23-5.4.56-10.77.97-16.11,10.61-135.53,79.88-248.03,79.88-248.03,119.4-36.9,156.76,10.28,156.76,10.28,47.88,36.41,67.82,89.25,73.04,143.7,1.9,19.78,1.85,39.77.5,59.27-4.73,68.27-25.49,130.48-35.11,156.23,22.6-58.27,39.25-111.83,51.01-160.99,5.78-24.16,10.38-47.24,13.94-69.3,13.76-85.31,11.88-155.24,1.84-211.82Z" />
          <path class="parte parte1" d="m594.55,239.15c-12.31-24.14-30.16-41.09-54.59-51.8-20.34-8.92-44.66-13.26-74.34-13.26-5.33,0-10.77.14-16.42.42,1.64,6.62,3.16,13.37,4.53,20.14.27,1.34.54,2.7.8,4.05,46.78,5.64,80.13,50.18,84.8,90.75,4.65,40.45-15.66,96.85-86.07,135.35-2.72,16.3-5.97,32.98-9.71,49.79,33.81-12.35,63.88-29.95,89.57-52.45,26.55-23.25,47.05-50.87,59.29-79.86,7.91-18.73,12.1-37.25,12.47-55.04.37-17.75-3.11-33.93-10.33-48.09Z" />
          <path class="parte parte3" d="m396.82,70.27c-1.01-1.65-2.02-3.26-3.03-4.84-2.02-3.17-4.04-6.2-6.05-9.12-1-1.46-2.01-2.88-3-4.28-1.99-2.79-3.97-5.46-5.93-8.01-1.95-2.55-3.88-4.97-5.78-7.28C351.97,11.1,335.12,0,335.12,0c-19.2,15.53-36.99,31.2-53.45,46.97-1.71,1.64-3.41,3.28-5.1,4.93-5.06,4.93-9.98,9.87-14.79,14.81-4.8,4.94-9.48,9.89-14.04,14.84-13.67,14.86-26.24,29.75-37.8,44.63-21.46,27.62-39.41,55.18-54.38,82.37,20.68-1.84,40.83-4.19,60.43-6.85,6.53-.89,13.01-1.81,19.42-2.76,3.21-.47,6.39-.95,9.57-1.44,9.52-1.46,18.9-2.97,28.14-4.51,3.08-.51,6.14-1.03,9.19-1.55,6.09-1.04,12.12-2.08,18.09-3.12,2.98-.52,5.95-1.04,8.9-1.57,8.85-1.56,17.55-3.12,26.1-4.64,5.7-1.02,11.33-2.02,16.89-3,19.47-3.43,38.11-6.58,55.86-9.14,7.61-1.1,15.06-2.09,22.35-2.94,2.43-.28,4.84-.55,7.23-.81-10.95-39.78-25.85-71.42-40.91-95.95Zm-83.28,93.31c-23.05,0-41.73-18.68-41.73-41.73s18.68-41.73,41.73-41.73,41.73,18.68,41.73,41.73-18.68,41.73-41.73,41.73Z" />
        </g>
      </svg>
      <div id="loadingMessage" style="display:flex; flex-direction: column; align-items: center;">
        <p style="color:white;">Enviando datos, por favor espere...</p>
        <div style="width: 100%; background: #eee; border-radius: 10px; height: 40px; margin-top: 10px;">
          <div id="barraCarga" style="width: 0%; height: 100%; background: pink; border-radius: 10px;"></div>
        </div>
      </div>
    </div>


    <!-- Formulario (HTML sin cambios) -->
    <form id="registroForm" onsubmit="enviarDatos(event)">

      <div id="logoAnimado"
        style="width: 100%; height:180px; display:flex; align-items:center;  justify-content:center; background-color:none;">
        <svg id="LogoSvgMantonet" class="logotipo" data-name="Capa 2" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 446.66 134.17">
          <title>Logotipo de Mantonet</title>
          <defs>
            <style>
              .cls-1 {
                fill: none;
                opacity: 1;
              }
              .logotipo {
                display: flex;
                height: 100%;
                width: 100%;
                stroke: white;
                stroke-width: 1.7;
                stroke-dasharray: 400;
                stroke-dashoffset: 400;
                animation: draw 8s linear infinite alternate;
                justify-content: center;
                align-items: center;
                background: none;
              }
              @keyframes draw {
                0% {
                  stroke-dashoffset: 400;
                  fill: transparent;
                }
                45% {
                  stroke-dashoffset: 0;
                  fill: white;
                }
                50% {
                  stroke-dashoffset: 0;
                  fill: transparent;
                }
                55% {
                  stroke-dashoffset: 0;
                  fill: white;
                }
                100% {
                  stroke-dashoffset: 400;
                  fill: transparent;
                }
              }
            </style>
          </defs>
          <g id="Capa_1-2" data-name="Capa 1">
            <g>
              <path class="cls-1 logotipo" d="m311.33,83.59c2.54-16.33-.32-32.54-2.5-41.5,3.14-1.54,4.83-5.13,3.85-8.62-1.1-3.92-5.18-6.2-9.1-5.1-3.92,1.1-6.2,5.18-5.1,9.1.98,3.46,4.27,5.64,7.72,5.35,2.09,8.77,4.84,24.66,2.41,40.44-.23.02-.46.04-.7.08-7.59-20.42-22.3-53.99-29.41-69.9,2.52-1.74,3.78-4.95,2.91-8.06-1.1-3.92-5.18-6.2-9.1-5.1-3.92,1.1-6.2,5.18-5.1,9.1.05.16.1.32.16.48-16.79,9.77-47.88,28.2-60.73,37.98-.35-.25-.73-.46-1.13-.65,2.99-9.4,10.74-27.2,27.83-34.56,1.25,2.29,3.68,3.84,6.47,3.84,4.07,0,7.38-3.3,7.38-7.38s-3.3-7.38-7.38-7.38-7.38,3.3-7.38,7.38c0,.33.03.66.07.98-18.27,7.73-26.46,26.59-29.59,36.45-.17-.01-.34-.03-.51-.03-4.07,0-7.38,3.3-7.38,7.38,0,3.52,2.47,6.47,5.78,7.2.12,15.78,4.31,52.31,39.43,62.3-.03.75.06,1.51.27,2.27,1.1,3.92,5.18,6.2,9.1,5.1,3.92-1.1,6.2-5.18,5.1-9.1-1.1-3.92-5.18-6.2-9.1-5.1-2.24.63-3.94,2.23-4.79,4.22-33.73-9.62-37.46-44.36-37.42-59.58,2.32-.31,4.3-1.7,5.42-3.66,4.76,1.65,11.66,4.05,19.69,6.83-.41,2.01-.63,4.08-.63,6.21,0,16.88,13.68,30.56,30.56,30.56,12,0,22.37-6.92,27.37-16.98,6.19,2.12,11.67,4,15.97,5.45-.14.99-.09,2.01.2,3.03.5,1.78,1.62,3.22,3.06,4.16-.55,1.41-1.15,2.8-1.83,4.16-4.85,9.74-12.46,17.08-22.67,21.91-1.7-2.69-5.01-4.06-8.23-3.16-3.92,1.1-6.2,5.18-5.1,9.1,1.1,3.92,5.18,6.2,9.1,5.1,3.74-1.05,5.98-4.81,5.22-8.55,10.84-5.08,18.93-12.86,24.08-23.22.7-1.41,1.32-2.85,1.89-4.3,1.14.25,2.37.23,3.57-.11,3.92-1.1,6.2-5.18,5.1-9.1-.7-2.48-2.58-4.3-4.87-5.03Zm-24.42-1.91c1.35-3.45,2.1-7.2,2.1-11.12,0-16.88-13.68-30.56-30.56-30.56-13.81,0-25.48,9.17-29.26,21.75-7.93-2.75-14.76-5.12-19.48-6.76.06-.37.09-.74.09-1.12,0-1.59-.51-3.07-1.37-4.27,11.5-8.31,40.32-25.76,60.29-37.43,1.76,2.05,4.57,3.04,7.35,2.36,7.1,15.87,21.77,49.38,29.33,69.71-1.18.68-2.12,1.66-2.76,2.81-4.24-1.43-9.64-3.28-15.73-5.37Z" />
              <path class="cls-1 logotipo" d="m40.76,43.88l-9.14,24.84c-2.29,6.48-4.11,12.11-5.41,17.29h-.23c-1.29-5.33-3.05-10.97-5.18-17.29l-8.76-24.84H3.58L0,95.23h6.32l1.37-22.02c.46-7.69.84-16.3.99-22.7h.15c1.45,6.09,3.5,12.72,5.94,19.96l8.3,24.46h5.03l9.07-24.91c2.59-7.09,4.72-13.49,6.48-19.5h.23c-.08,6.4.38,15.01.76,22.17l1.29,22.55h6.48l-3.2-51.35h-8.46Z" />
              <path class="cls-1 logotipo" d="m75.42,43.88l-17.45,51.35h6.86l5.33-16.15h18.21l5.49,16.15h7.08l-17.52-51.35h-8Zm-3.89,30.02l5.03-14.86c.99-3.12,1.83-6.25,2.59-9.29h.15c.76,2.97,1.52,6.02,2.67,9.37l5.03,14.78h-15.47Z" />
              <path class="cls-1 logotipo" d="m140.79,65.36c0,8,.15,14.25.76,21.1l-.15.08c-2.44-5.26-5.41-10.67-9.22-16.68l-16.46-25.98h-7.24v51.35h6.25v-21.94c0-8.53-.15-14.7-.53-21.18l.23-.08c2.59,5.56,6.02,11.43,9.6,17.14l16.3,26.06h6.7v-51.35h-6.25v21.49Z" />
              <polygon class="cls-1 logotipo" points="152.75 49.52 168.37 49.52 168.37 95.23 175.07 95.23 175.07 49.52 190.77 49.52 190.77 43.88 152.75 43.88 152.75 49.52" />
              <path class="cls-1 logotipo" d="m357.98,65.36c0,8,.15,14.25.76,21.1l-.15.08c-2.44-5.26-5.41-10.67-9.22-16.68l-16.46-25.98h-7.24v51.35h6.25v-21.94c0-8.53-.15-14.7-.53-21.18l.23-.08c2.59,5.56,6.02,11.43,9.6,17.14l16.3,26.06h6.7v-51.35h-6.25v21.49Z" />
              <polygon class="cls-1 logotipo" points="382.44 71.15 402.4 71.15 402.4 65.67 382.44 65.67 382.44 49.44 403.54 49.44 403.54 43.88 375.81 43.88 375.81 95.23 404.68 95.23 404.68 89.67 382.44 89.67 382.44 71.15" />
              <polygon class="cls-1 logotipo" points="408.64 43.88 408.64 49.52 424.26 49.52 424.26 95.23 430.97 95.23 430.97 49.52 446.66 49.52 446.66 43.88 408.64 43.88" />
            </g>
          </g>
        </svg>
      </div>

      <div class="titulo">
        <label>REGISTRO DE FINANZAS</label>
      </div>

      <div style="width:100%; display:flex; align-items:center; justify-content: center;">
        <a href="https://script.google.com/macros/s/AKfycbwZEGK6yvdLiCBQZoiKEFgt57t4MxzmypypzOoQ0Z_1VVfydcDjMdk2C0AG_gk5sYn5/exec"
          target="_blank" class="BotonNuevoCliente">
          Registar Nuevo Cliente
        </a>
      </div>

      <fieldset>
        <legend>Información de la Operación</legend>
        <label>Fecha Operación:</label>
        <input type="date" name="fechaOperacion">

        <label for="opcionSelect">Empresa:</label>
        <select id="opcionSelect" name="empresa" required>
          <option value="" disabled selected>***</option>
          <option value="ALSE">ALSE</option>
          <option value="MANTONET">MANTONET</option>
        </select>

        <label for="proyecto">Proyecto</label>
        <select id="proyecto" name="proyecto" required onchange="this.value = this.value.toUpperCase()">
          <option value="" disabled selected>***</option>
          <!-- Las opciones se cargarán aquí por JavaScript -->
        </select>

        <label for="categoria">Categoría:</label>
        <select name="categoria" id="categoria" required>
          <option value="" disabled selected>***</option>
          <option value="ADMINISTRACIÓN">ADMINISTRACIÓN</option>
          <option value="MATERIAL">MATERIAL</option>
          <option value="HERRAMIENTA">HERRAMIENTA</option>
          <option value="EQUIPO DE SEGURIDAD">EQUIPO DE SEGURIDAD</option>
          <option value="TRANSPORTE">TRANSPORTE</option>
          <option value="ALIMENTOS">ALIMENTOS</option>
          <option value="INGRESO">INGRESO</option>
          <option value="MANO DE OBRA">MANO DE OBRA</option>
          <option value="DIVIDENDOS">DIVIDENDOS</option>
          <option value="PROPINA">PROPINA</option>
        </select>

        <label>Concepto:</label>
        <input type="text" name="concepto" id="concepto" oninput="this.value=this.value.toUpperCase()" required
          placeholder="***">

        <label>Tipo:</label>
        <select name="tipo" required>
          <option value="" disabled selected>***</option>
          <option value="GASTO">GASTO</option>
          <option value="INGRESO">INGRESO</option>
        </select>

        <label>Inversor:</label>
        <select name="inversor" required>
          <option value="" disabled selected>***</option>
          <option value="SERGIO">SERGIO</option>
          <option value="ALEJANDRA">ALEJANDRA</option>
          <option value="AMBOS">AMBOS</option>
          <option value="PRESUPUESTO DE PROYECTO">PRESUPUESTO DE PROYECTO</option>
        </select>

        <label>Estatus:</label>
        <select name="estatus" required>
          |<option value="" disabled selected>***</option>
          <option value="FACTURAR PENDIENTE">FACTURAR PENDIENTE</option>
          <option value="FACTURADO">FACTURADO</option>
          <option value="NO FACTURABLE">NO FACTURABLE</option>
          <option value="NO PAGADO">NO PAGADO</option>
          <option value="PAGADO">PAGADO</option>
        </select>

        <label>Monto Operación:</label>
        <input type="text" name="monto" id="montoOperacion" inputmode="decimal" oninput="formatearMonto(this)"
          placeholder="$0.00" required>
      </fieldset>

      <fieldset style="display:none;">
        <legend>Datos Ocultos</legend>
        <label>Mes:</label>
        <input type="text" name="mes">
        <label>Año:</label>
        <input type="number" name="year">
        <label>Check:</label>
        <input type="checkbox" name="check">
        <label>$ IVA:</label>
        <input type="number" name="iva" step="0.01">
        <label>$ ISR:</label>
        <input type="number" name="isr" step="0.01">
        <label>$ ISR Retenido:</label>
        <input type="number" name="isrRetenido" step="0.01">
        <label>$ IVA Retenido:</label>
        <input type="number" name="ivaRetenido" step="0.01">
        <label>$ Neto:</label>
        <input type="number" name="neto" step="0.01">
        <label>Fecha Factura:</label>
        <input type="date" name="fechaFactura">
        <label>Mes Factura:</label>
        <input type="text" name="mesFactura">
        <label>Link Carpeta:</label>
        <input type="url" name="linkCarpeta">
        <label>Link Ticket:</label>
        <input type="url" name="linkTicket">
        <label>Factura:</label>
        <input type="text" name="factura">
        <label>Link Factura:</label>
        <input type="url" name="linkFactura">
        <label>XML:</label>
        <input type="text" name="xml">
        <label>Link XML:</label>
        <input type="url" name="linkXml">
      </fieldset>

      <fieldset>
        <legend>Ticket y Facturación</legend>
        <label>Ticket:</label>
        <select name="ticket" id="ticket" required>
          <option value="" disabled selected>***</option>
          <option value="NO">NO</option>
          <option value="SI">SI</option>
        </select>
      </fieldset>

      <fieldset id="ticketFieldset">
        <div id="subirTicket">
          <label>Subir Imagen del Ticket:</label>
          <button type="button" class="btn" id="uploadBtn">Subir Imagen</button>
          <input type="file" class="hidden" id="ticketImage" accept="image/*">
        </div>

        <legend>Captura de Imagen</legend>
        <label for="cameraSelect">Seleccionar cámara:</label>
        <select id="cameraSelect">
          <option value="">--Selecciona una cámara--</option>
        </select>

        <video id="video" width="320" height="240" autoplay></video>
        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
        <button id="captureButton" class="btn" type="button">Capturar Foto</button>
        <div id="imagenPrototipo"></div>
      </fieldset>

      <button type="submit" class="full-width, btn">Registrar</button>
    </form>
  </div>

  <footer class="footer-content">
    <p>&copy; 2025 MANTONET.</p>
    <p> </p>
    <p>Todos los derechos reservados.</p>
    <p>V: 2025_05_10_5</p>
  </footer>

</body>
</html>